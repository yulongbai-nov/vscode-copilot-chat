name: Build VSIX and attach to release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (defaults to current ref if it is a tag)'
        required: false
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-publish:
    name: Build VSIX
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          lfs: false
          fetch-depth: 0  # Required for hydrateSimulationCache merge-base detection

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: '22.14.x'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Hydrate simulation cache
        run: npx --yes tsx script/hydrateSimulationCache.ts

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: NODE_OPTIONS=--experimental-strip-types npm run build

      - name: Build VSIX
        run: npm exec vsce package

      - name: Locate VSIX
        id: vsix
        run: |
          set -e
          file="$(ls -1 *.vsix | head -n 1)"
          echo "file=$file" >>"$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix
          path: ${{ steps.vsix.outputs.file }}

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.vsix.outputs.file }}
          tag_name: ${{ inputs.tag || github.ref_name }}
          name: ${{ inputs.tag || github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
